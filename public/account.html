<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Artisan Jewelry Co - My Account</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header>
        <div class="container">
            <a href="index.html" class="logo">Artisan Jewelry Co</a>
            <button class="hamburger-menu" aria-label="Toggle navigation">
                <i class="fas fa-bars"></i>
            </button>
            <nav class="main-nav">
                <ul>
                    <li><a href="index.html" class="nav-link" data-page="index">Index</a></li>
                    <li><a href="products.html" class="nav-link" data-page="products">Products</a></li>
                    <li><a href="product-detail.html" class="nav-link" data-page="product-detail">Product Detail</a></li>
                    <li><a href="cart.html" class="nav-link" data-page="cart">Cart</a></li>
                    <li><a href="checkout.html" class="nav-link" data-page="checkout">Checkout</a></li>
                    <li><a href="login.html" class="nav-link" data-page="login">Login</a></li>
                    <li><a href="signup.html" class="nav-link" data-page="signup">Sign Up</a></li>
                    <li><a href="account.html" class="nav-link current" data-page="account">Account</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <section class="account-dashboard">
            <div class="container">
                <h2>My Account Dashboard</h2>
                <div class="account-grid">
                    <aside class="account-sidebar">
                        <nav>
                            <ul>
                                <li><a href="#profile" class="sidebar-link active">Profile Information</a></li>
                                <li><a href="#orders" class="sidebar-link">My Orders</a></li>
                                <li><a href="#address" class="sidebar-link">Shipping Addresses</a></li>
                                <li><a href="#" id="logout-button" class="sidebar-link">Logout</a></li>
                            </ul>
                        </nav>
                    </aside>
                    <div class="account-content">
                        <div id="profile" class="account-section active">
                            <h3>Profile Information</h3>
                            <form id="profile-form" class="form">
                                <div class="form-group">
                                    <label for="profile-name">Name</label>
                                    <input type="text" id="profile-name" name="name" disabled>
                                </div>
                                <div class="form-group">
                                    <label for="profile-email">Email Address</label>
                                    <input type="email" id="profile-email" name="email" disabled>
                                </div>
                                <div class="form-group">
                                    <label for="profile-phone">Phone Number</label>
                                    <input type="tel" id="profile-phone" name="phone" value="" autocomplete="tel">
                                </div>
                                <div class="form-group">
                                    <label for="profile-password">New Password</label>
                                    <input type="password" id="profile-password" name="password" autocomplete="new-password" placeholder="Leave blank to keep current">
                                    <div class="error-message" id="profile-password-error"></div>
                                </div>
                                <button type="submit" class="btn btn-primary" id="update-profile-button">
                                    <span class="button-text">Update Profile</span>
                                    <span class="spinner" style="display: none;"></span>
                                </button>
                                <div class="form-message" id="profile-message" style="display: none;"></div>
                            </form>
                        </div>

                        <div id="orders" class="account-section">
                            <h3>My Orders</h3>
                            <div id="order-list">
                                <p class="loading-message">Loading orders...</p>
                                <!-- Orders will be loaded here by JavaScript -->
                            </div>
                        </div>

                        <div id="address" class="account-section">
                            <h3>Shipping Addresses</h3>
                            <div id="address-list">
                                <p>No addresses saved yet.</p>
                                <!-- Addresses will be loaded here or managed here -->
                            </div>
                            <button class="btn btn-secondary mt-3">Add New Address</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-brand">
                    <h3>Artisan Jewelry Co</h3>
                    <p>Handcrafted with passion, adorned with style.</p>
                </div>
                <div class="footer-nav">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href="index.html">Home</a></li>
                        <li><a href="products.html">Shop All</a></li>
                        <li><a href="cart.html">Your Cart</a></li>
                        <li><a href="account.html">My Account</a></li>
                    </ul>
                </div>
                <div class="footer-social">
                    <h4>Connect With Us</h4>
                    <a href="https://instagram.com/artisanjewelry" target="_blank" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                    <a href="mailto:shop@artisanjewelry.com" aria-label="Email"><i class="fas fa-envelope"></i></a>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2023 Artisan Jewelry Co. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="js/products.js"></script> <!-- For global nav/mobile menu -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_BASE = window.location.origin + '/api';
            const token = localStorage.getItem('token');
            let currentUser = JSON.parse(localStorage.getItem('user'));

            // Redirect if not authenticated
            if (!token || !currentUser) {
                window.location.href = 'login.html';
                return;
            }

            const profileForm = document.getElementById('profile-form');
            const profileNameInput = document.getElementById('profile-name');
            const profileEmailInput = document.getElementById('profile-email');
            const profilePhoneInput = document.getElementById('profile-phone');
            const profilePasswordInput = document.getElementById('profile-password');
            const updateProfileButton = document.getElementById('update-profile-button');
            const profileMessage = document.getElementById('profile-message');
            const logoutButton = document.getElementById('logout-button');
            const orderList = document.getElementById('order-list');
            const sidebarLinks = document.querySelectorAll('.sidebar-link');
            const accountSections = document.querySelectorAll('.account-section');

            // Set initial profile data
            profileNameInput.value = currentUser.name || ''; // Assuming user object has a name
            profileEmailInput.value = currentUser.email;
            profilePhoneInput.value = currentUser.phone || '';

            // Handle sidebar navigation
            sidebarLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (link.id === 'logout-button') {
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        window.location.href = 'login.html';
                        return;
                    }

                    sidebarLinks.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');

                    const targetId = link.getAttribute('href').substring(1);
                    accountSections.forEach(section => {
                        section.classList.remove('active');
                        if (section.id === targetId) {
                            section.classList.add('active');
                        }
                    });

                    // Load orders if "My Orders" is clicked
                    if (targetId === 'orders' && orderList.dataset.loaded !== 'true') {
                        fetchOrders();
                    }
                });
            });

            // Update profile form submission
            profileForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                let isValid = true;
                const newPassword = profilePasswordInput.value;

                if (newPassword && newPassword.length < 6) {
                    document.getElementById('profile-password-error').textContent = 'Password must be at least 6 characters long.';
                    isValid = false;
                } else {
                    document.getElementById('profile-password-error').textContent = '';
                }

                if (!isValid) return;

                updateProfileButton.querySelector('.button-text').style.display = 'none';
                updateProfileButton.querySelector('.spinner').style.display = 'inline-block';
                updateProfileButton.disabled = true;
                profileMessage.style.display = 'none';

                const updateData = {
                    name: profileNameInput.value,
                    phone: profilePhoneInput.value
                };
                if (newPassword) {
                    updateData.password = newPassword;
                }

                try {
                    const response = await fetch(`${API_BASE}/users/${currentUser._id}`, { // Using /users/:id as per spec
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(updateData)
                    });

                    const data = await response.json();

                    if (data.success) {
                        profileMessage.textContent = 'Profile updated successfully!';
                        profileMessage.className = 'form-message success';
                        profileMessage.style.display = 'block';
                        localStorage.setItem('user', JSON.stringify(data.data)); // Update local storage user
                        currentUser = data.data; // Update current user object
                        profilePasswordInput.value = ''; // Clear password field
                    } else {
                        profileMessage.textContent = data.message || 'Failed to update profile.';
                        profileMessage.className = 'form-message error';
                        profileMessage.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Update profile error:', error);
                    profileMessage.textContent = 'An error occurred while updating profile.';
                    profileMessage.className = 'form-message error';
                    profileMessage.style.display = 'block';
                } finally {
                    updateProfileButton.querySelector('.button-text').style.display = 'inline-block';
                    updateProfileButton.querySelector('.spinner').style.display = 'none';
                    updateProfileButton.disabled = false;
                }
            });

            // Fetch orders function
            async function fetchOrders() {
                orderList.innerHTML = '<p class="loading-message">Loading orders...</p>';
                try {
                    const response = await fetch(`${API_BASE}/orders/user/${currentUser._id}`, { // Assuming an endpoint for user-specific orders
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    const data = await response.json();

                    if (data.success && data.data.length > 0) {
                        orderList.innerHTML = '';
                        data.data.forEach(order => {
                            const orderDiv = document.createElement('div');
                            orderDiv.className = 'order-item';
                            const orderDate = new Date(order.createdAt).toLocaleDateString();
                            const totalAmount = order.totalAmount.toFixed(2);
                            const itemsList = order.items.map(item => `<li>${item.name} (x${item.quantity}) - $${(item.price * item.quantity).toFixed(2)}</li>`).join('');

                            orderDiv.innerHTML = `
                                <h4>Order ID: ${order._id}</h4>
                                <p><strong>Date:</strong> ${orderDate}</p>
                                <p><strong>Total:</strong> $${totalAmount}</p>
                                <p><strong>Status:</strong> ${order.status}</p>
                                <h5>Items:</h5>
                                <ul>${itemsList}</ul>
                            `;
                            orderList.appendChild(orderDiv);
                        });
                        orderList.dataset.loaded = 'true';
                    } else {
                        orderList.innerHTML = '<p>You have no past orders.</p>';
                    }
                } catch (error) {
                    console.error('Error fetching orders:', error);
                    orderList.innerHTML = '<p class="error-message">Failed to load orders. Please try again later.</p>';
                }
            }

            // Initial load for active section (profile)
            document.querySelector('.account-sidebar .sidebar-link.active').click();
        });
    </script>
</body>
</html>